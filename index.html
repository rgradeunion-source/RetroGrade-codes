<!DOCTYPE html>
<html>
<head>
<title>My Game Codes</title>
<style>
button { margin: 5px; }
#error { color: red; margin-top: 20px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body>
<h1>Access Your Codes</h1>
<input id="email" placeholder="Enter your order email">
<button onclick="loadCodes()">Login</button>
<div id="codes"></div>
<div id="error"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBa-jKP7FsN2eeCDhRLumZiumHHEtXtZqg",
  authDomain: "retrogradecodes.firebaseapp.com",
  databaseURL: "https://retrogradecodes-default-rtdb.firebaseio.com",
  projectId: "retrogradecodes",
  storageBucket: "retrogradecodes.firebasestorage.app",
  messagingSenderId: "965215909644",
  appId: "1:965215909644:web:67c041bd24463cab993b29"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function loadCodes() {
  document.getElementById('codes').innerHTML = '';
  document.getElementById('error').innerHTML = '';

  const email = document.getElementById('email').value.trim().toLowerCase();
  const ordersDoc = await db.collection('orders').doc(email).get();

  if (!ordersDoc.exists || (ordersDoc.data().games || []).length === 0) {
    document.getElementById('error').innerHTML = "No game codes are associated with this email.";
    return;
  }

  const games = ordersDoc.data().games || [];
  let html = "";

  for (const game of games) {
    const codeDoc = await db.collection('codes').doc(game).get();
    const code = codeDoc.exists ? codeDoc.data().code : "Not available";
    html += `<div>
      <strong>${game}</strong>: ${code}
      <button onclick="copyCode('${code}')">Copy</button>
      <button onclick="refreshCode('${game}')">Refresh</button>
    </div>`;
  }

  document.getElementById('codes').innerHTML = html;
}

function copyCode(code) {
  navigator.clipboard.writeText(code);
  alert("Copied!");
}

async function refreshCode(game) {
  const codeDoc = await db.collection('codes').doc(game).get();
  const code = codeDoc.exists ? codeDoc.data().code : "Not available";
  alert(`Refreshed code: ${code}`);
}
</script>
</body>
</html>
